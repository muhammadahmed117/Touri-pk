{% extends 'base.html' %}
{% load static %}

{% block title %}Customise Your Package | TouriPK{% endblock %}

{% block content %}
<style>
    @media print {
        .no-print { display: none !important; }
        body { background: white !important; }
        .calc-page { padding: 20px !important; }
    }

    .calc-page {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        min-height: 100vh;
        padding: 40px 0;
    }

    .calc-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .calc-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .calc-header h1 {
        font-size: 2.5rem;
        font-weight: 900;
        color: #000000;
        margin-bottom: 10px;
    }

    .calc-header p {
        color: #666666;
        font-size: 1.1rem;
    }

    .package-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .package-card {
        background: white;
        border: 3px solid #e2e8f0;
        border-radius: 15px;
        padding: 25px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .package-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border-color: #000000;
    }

    .package-card.active {
        background: #000000;
        color: white;
        border-color: #000000;
    }

    .package-card h3 {
        font-size: 1.4rem;
        font-weight: 800;
        margin-bottom: 10px;
    }

    .package-card p {
        font-size: 0.9rem;
        opacity: 0.8;
        margin: 0;
    }

    .quotation-card {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .quote-title {
        text-align: center;
        padding: 25px;
        background: #000000;
        color: white;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    .quote-title h2 {
        font-size: 1.8rem;
        font-weight: 800;
        margin: 0;
    }

    .info-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .info-item label {
        display: block;
        font-weight: 700;
        color: #000000;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .info-item input, .info-item select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
    }

    .info-item input:focus, .info-item select:focus {
        outline: none;
        border-color: #000000;
    }

    /* Stepper +/- buttons */
    .stepper-wrap { display: flex; align-items: center; gap: 0; }
    .stepper-wrap input[type=number] { -moz-appearance: textfield; text-align: center; border-left: none; border-right: none; border-radius: 0; flex: 1; font-weight: 700; }
    .stepper-wrap input[type=number]::-webkit-outer-spin-button,
    .stepper-wrap input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .stepper-btn { width: 40px; min-width: 40px; height: 42px; border: 2px solid #e2e8f0; background: #f8f9fa; color: #333; font-size: 1.3rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; user-select: none; }
    .stepper-btn:hover { background: #000; color: #fff; border-color: #000; }
    .stepper-btn:active { transform: scale(0.95); }
    .stepper-btn.minus { border-radius: 8px 0 0 8px; }
    .stepper-btn.plus { border-radius: 0 8px 8px 0; }

    .summary-card {
        background: #fffbeb;
        border-left: 4px solid #000000;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .summary-item {
        padding: 12px;
        background: white;
        border-radius: 6px;
    }

    .summary-item label {
        display: block;
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 5px;
    }

    .summary-item .value {
        font-size: 1.3rem;
        font-weight: 800;
        color: #000000;
    }

    .cost-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
    }

    .cost-table th {
        background: #000000;
        color: white;
        padding: 12px 8px;
        text-align: left;
        font-weight: 700;
        font-size: 0.9rem;
        border: 1px solid #333;
    }

    .cost-table td {
        padding: 10px 8px;
        border: 1px solid #e2e8f0;
        background: white;
    }

    .category-header {
        background: #f8f9fa !important;
        font-weight: 800;
        color: #000000;
        font-size: 1.1rem;
    }

    .amount-cell {
        text-align: right;
        font-weight: 700;
        color: #000000;
        background: #f8f9fa !important;
    }

    .total-row {
        background: #000000 !important;
        color: white !important;
        font-size: 1.3rem;
        font-weight: 900;
    }

    .total-row td {
        border-color: #000 !important;
        padding: 15px 8px;
    }

    .subtotal-row {
        background: #e2e8f0 !important;
        font-weight: 800;
        font-size: 1.1rem;
    }

    .notes-section {
        background: #fffbeb;
        border-left: 4px solid #000000;
        padding: 20px;
        border-radius: 8px;
        margin: 30px 0;
    }

    .notes-section h4 {
        font-weight: 800;
        color: #000000;
        margin-bottom: 12px;
    }

    .notes-section p {
        margin: 8px 0;
        color: #666;
    }

    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 30px;
    }

    .btn {
        padding: 15px 25px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #000000;
        color: white;
    }

    .btn-primary:hover {
        background: #333;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #f8f9fa;
        color: #000;
        border: 2px solid #e2e8f0;
    }

    .btn-secondary:hover {
        background: #e2e8f0;
    }
</style>

<div class="calc-page">
    <div class="calc-container">
        <div class="calc-header no-print">
            <h1><i class="fas fa-sliders-h"></i> Customise Your Package</h1>
            <p>Calculate your tour package cost with automatic pricing</p>
        </div>

        <!-- Package Selection -->
        <div class="no-print">
            <div class="package-selector">
                <div class="package-card active" onclick="selectPackage('swat')">
                    <h3><i class="fas fa-mountain"></i> Swat - Naran - Kashmir</h3>
                    <p>Valley of Mountains & Lakes</p>
                </div>
                <div class="package-card" onclick="selectPackage('hunza')">
                    <h3><i class="fas fa-mountain-sun"></i> Hunza</h3>
                    <p>Land of Legends</p>
                </div>
                <div class="package-card" onclick="selectPackage('skardu')">
                    <h3><i class="fas fa-mountain-city"></i> Skardu</h3>
                    <p>Gateway to Heaven</p>
                </div>
            </div>
        </div>

        <div class="quotation-card">
            <!-- Title -->
            <div class="quote-title">
                <h2 id="packageTitle">Swat - Naran - Kashmir Package</h2>
            </div>

            <!-- Info Row -->
            <div class="info-row no-print">
                <div class="info-item">
                    <label><i class="fas fa-users"></i> Number of People <small style="color:#888;">(7-27)</small></label>
                    <div class="stepper-wrap">
                        <button type="button" class="stepper-btn minus" data-target="numPeople">−</button>
                        <input type="number" id="numPeople" value="15" min="7" max="27" onchange="handlePeopleChange()">
                        <button type="button" class="stepper-btn plus" data-target="numPeople">+</button>
                    </div>
                </div>
                <div class="info-item">
                    <label><i class="fas fa-calendar-days"></i> Number of Days</label>
                    <div class="stepper-wrap">
                        <button type="button" class="stepper-btn minus" data-target="numDays">−</button>
                        <input type="number" id="numDays" value="5" min="3" max="10" onchange="updateCalculations()">
                        <button type="button" class="stepper-btn plus" data-target="numDays">+</button>
                    </div>
                </div>
                <div class="info-item">
                    <label><i class="fas fa-moon"></i> Number of Nights</label>
                    <div class="stepper-wrap">
                        <button type="button" class="stepper-btn minus" data-target="numNights">−</button>
                        <input type="number" id="numNights" value="4" min="0" onchange="updateCalculations()">
                        <button type="button" class="stepper-btn plus" data-target="numNights">+</button>
                    </div>
                </div>
                <div class="info-item">
                    <label><i class="fas fa-car"></i> Transport Type <small style="color:#888;">(Auto)</small></label>
                    <select id="transportType" disabled onchange="updateCalculations()" style="background-color: #f0f0f0;">
                        <option value="coaster">Coaster (14-27 people)</option>
                        <option value="grand_cabin">Grand Cabin (7-13 people)</option>
                    </select>
                </div>
                <div class="info-item">
                    <label><i class="fas fa-bed"></i> Number of Rooms <small style="color:#888;">(Min: 1 per 5 people)</small></label>
                    <div class="stepper-wrap">
                        <button type="button" class="stepper-btn minus" data-target="numRooms">−</button>
                        <input type="number" id="numRooms" value="3" min="1" onchange="autoCalculateRooms(); updateCalculations()">
                        <button type="button" class="stepper-btn plus" data-target="numRooms">+</button>
                    </div>
                </div>
                <div class="info-item">
                    <label><i class="fas fa-star"></i> Room Category</label>
                    <select id="roomCategory" onchange="updateCalculations()">
                        <option value="standard">Standard (5,000/day)</option>
                        <option value="delux">Delux (10,000/day)</option>
                        <option value="luxury">Luxury (15,000/day)</option>
                    </select>
                </div>
            </div>

            <!-- Auto-Calculated Summary -->
            <div class="summary-card">
                <h4 style="margin-bottom: 15px; font-weight: 800;"><i class="fas fa-chart-line"></i> Package Summary</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <label>Transport Cost</label>
                        <div class="value" id="transportCost">0</div>
                    </div>
                    <div class="summary-item">
                        <label>Accommodation Cost</label>
                        <div class="value" id="accommodationCost">0</div>
                    </div>
                    <div class="summary-item">
                        <label>Food Cost</label>
                        <div class="value" id="foodCost">0</div>
                    </div>
                    <div class="summary-item">
                        <label>Activities Cost</label>
                        <div class="value" id="activitiesCost">0</div>
                    </div>
                </div>
            </div>

            <!-- Main Table -->
            <table class="cost-table" id="detailsTable">
                <thead>
                    <tr>
                        <th style="width: 30%;">Item</th>
                        <th style="width: 35%;">Description</th>
                        <th style="width: 12%;">Quantity</th>
                        <th style="width: 12%;">Rate</th>
                        <th style="width: 11%;">Amount</th>
                    </tr>
                </thead>
                <tbody id="mainTableBody">
                    <!-- Content will be generated by JavaScript -->
                </tbody>
            </table>

            <!-- Notes -->
            <div class="notes-section">
                <h4><i class="fas fa-exclamation-circle"></i> Important Notes</h4>
                <p>✓ Transport cost is fixed for the selected vehicle type</p>
                <p>✓ Accommodation charged per room per night</p>
                <p>✓ Food charged per person per day</p>
                <p>✓ First Aid Box is compulsory (Rs. 1,000)</p>
                <p>✓ Coaster capacity: 15-27 people | Grand Cabin capacity: 7-13 people</p>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons no-print">
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Quotation
                </button>
                <button class="btn btn-primary" onclick="downloadPDF()">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button class="btn btn-secondary" onclick="saveData()">
                    <i class="fas fa-save"></i> Save Draft
                </button>
                <button class="btn btn-secondary" onclick="location.reload()">
                    <i class="fas fa-refresh"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Pricing data for different packages
const packageData = {
    swat: {
        name: 'Swat - Naran - Kashmir',
        transport: {
            coaster: { rent: 26000, fuel: 85000, toll: 15000, firstAid: 1000, minPeople: 15, maxPeople: 27 },
            grand_cabin: { rent: 20000, fuel: 70000, toll: 15000, firstAid: 1000, minPeople: 7, maxPeople: 13 }
        },
        accommodation: { luxury: 15000, delux: 10000, standard: 5000 },
        food: { breakfast: 500, dinner: 1050 },
        activities: { bonfire: 7000, guide: 2500 }
    },
    hunza: {
        name: 'Hunza',
        transport: {
            coaster: { rent: 26000, fuel: 130000, toll: 20000, firstAid: 1000, minPeople: 15, maxPeople: 27 },
            grand_cabin: { rent: 20000, fuel: 100000, toll: 20000, firstAid: 1000, minPeople: 7, maxPeople: 13 }
        },
        accommodation: { luxury: 15000, delux: 10000, standard: 5000 },
        food: { breakfast: 500, dinner: 1050 },
        activities: { bonfire: 7000, guide: 2500 }
    },
    skardu: {
        name: 'Skardu',
        transport: {
            coaster: { rent: 26000, fuel: 150000, toll: 20000, firstAid: 1000, minPeople: 15, maxPeople: 27 },
            grand_cabin: { rent: 20000, fuel: 130000, toll: 20000, firstAid: 1000, minPeople: 7, maxPeople: 13 }
        },
        accommodation: { luxury: 15000, delux: 10000, standard: 5000 },
        food: { breakfast: 500, dinner: 1050 },
        activities: { bonfire: 7000, guide: 2500 }
    }
};

let currentPackage = 'swat';

function selectPackage(packageName) {
    currentPackage = packageName;
    
    // Update active state
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('active');
    });
    event.target.closest('.package-card').classList.add('active');
    
    // Update title
    document.getElementById('packageTitle').textContent = packageData[packageName].name + ' Package';
    
    // Reset and recalculate
    updateCalculations();
}

function clampDays() {
    const daysInput = document.getElementById('numDays');
    let val = parseInt(daysInput.value);
    if (!val || val < 3) daysInput.value = 3;
    if (val > 10) daysInput.value = 10;
}

function clampPeople() {
    const peopleInput = document.getElementById('numPeople');
    let val = parseInt(peopleInput.value);
    if (!val || val < 7) peopleInput.value = 7;
    if (val > 27) peopleInput.value = 27;
}

function autoSelectVehicle() {
    const numPeople = parseInt(document.getElementById('numPeople').value) || 7;
    const transportSelect = document.getElementById('transportType');
    if (numPeople <= 13) {
        transportSelect.value = 'grand_cabin';
    } else {
        transportSelect.value = 'coaster';
    }
}

function autoCalculateRooms() {
    const numPeople = parseInt(document.getElementById('numPeople').value) || 7;
    const minRooms = Math.ceil(numPeople / 5);
    const roomsInput = document.getElementById('numRooms');
    roomsInput.min = minRooms;
    if (parseInt(roomsInput.value) < minRooms) {
        roomsInput.value = minRooms;
    }
}

function handlePeopleChange() {
    clampPeople();
    autoSelectVehicle();
    autoCalculateRooms();
    updateCalculations();
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('numDays').addEventListener('input', function() { clampDays(); updateCalculations(); });
    document.getElementById('numDays').addEventListener('blur', clampDays);
    document.getElementById('numPeople').addEventListener('input', handlePeopleChange);
    document.getElementById('numPeople').addEventListener('blur', function() { clampPeople(); autoSelectVehicle(); autoCalculateRooms(); });
    // Initialize auto values
    autoSelectVehicle();
    autoCalculateRooms();

    // Stepper +/- buttons
    document.querySelectorAll('.stepper-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const input = document.getElementById(this.dataset.target);
            const min = parseInt(input.min) || 0;
            const max = parseInt(input.max) || 9999;
            let val = parseInt(input.value) || min;
            if (this.classList.contains('plus')) {
                if (val < max) input.value = val + 1;
            } else {
                if (val > min) input.value = val - 1;
            }
            input.dispatchEvent(new Event('input'));
            input.dispatchEvent(new Event('change'));
        });
    });
});

function updateCalculations() {
    clampDays();
    clampPeople();
    autoSelectVehicle();
    autoCalculateRooms();
    const numPeople = parseInt(document.getElementById('numPeople').value) || 7;
    const numDays = parseInt(document.getElementById('numDays').value) || 3;
    const numNights = parseInt(document.getElementById('numNights').value) || 0;
    const transportType = document.getElementById('transportType').value;
    const numRooms = parseInt(document.getElementById('numRooms').value) || 0;
    const roomCategory = document.getElementById('roomCategory').value;
    
    const pkg = packageData[currentPackage];
    const transport = pkg.transport[transportType];
    
    // Validate people count for transport
    if (numPeople < transport.minPeople || numPeople > transport.maxPeople) {
        // Show warning but continue calculation
        console.log(`Warning: ${transportType === 'coaster' ? 'Coaster' : 'Grand Cabin'} is for ${transport.minPeople}-${transport.maxPeople} people!`);
    }
    
    // Calculate costs
    const transportCost = (transport.rent * numDays) + transport.fuel + transport.toll + transport.firstAid;
    const accommodationCost = numRooms * numNights * pkg.accommodation[roomCategory];
    const foodCost = numPeople * numDays * (pkg.food.breakfast + pkg.food.dinner);
    const activitiesCost = 0; // Will be calculated based on selections
    
    // Update summary
    document.getElementById('transportCost').textContent = 'Rs. ' + transportCost.toLocaleString();
    document.getElementById('accommodationCost').textContent = 'Rs. ' + accommodationCost.toLocaleString();
    document.getElementById('foodCost').textContent = 'Rs. ' + foodCost.toLocaleString();
    document.getElementById('activitiesCost').textContent = 'Rs. ' + activitiesCost.toLocaleString();
    
    // Generate detailed table
    generateDetailedTable();
}

function generateDetailedTable() {
    const numPeople = parseInt(document.getElementById('numPeople').value) || 0;
    const numDays = parseInt(document.getElementById('numDays').value) || 0;
    const numNights = parseInt(document.getElementById('numNights').value) || 0;
    const transportType = document.getElementById('transportType').value;
    const numRooms = parseInt(document.getElementById('numRooms').value) || 0;
    const roomCategory = document.getElementById('roomCategory').value;
    
    const pkg = packageData[currentPackage];
    const transport = pkg.transport[transportType];
    const transportName = transportType === 'coaster' ? 'Coaster' : 'Grand Cabin';
    
    let html = '';
    let grandTotal = 0;
    
    // Transport Section
    html += `<tr class="category-header"><td colspan="5"><strong>TRANSPORT (${transportName})</strong></td></tr>`;
    
    const rentAmount = transport.rent * numDays;
    html += `<tr>
        <td>Vehicle Rent</td>
        <td>${transportName} (${transport.minPeople}-${transport.maxPeople} people capacity)</td>
        <td>${numDays} days</td>
        <td>Rs. ${transport.rent.toLocaleString()}/day</td>
        <td class="amount-cell">Rs. ${rentAmount.toLocaleString()}</td>
    </tr>`;
    grandTotal += rentAmount;
    
    html += `<tr>
        <td>Fuel</td>
        <td>Fixed cost for ${currentPackage}</td>
        <td>1</td>
        <td>Rs. ${transport.fuel.toLocaleString()}</td>
        <td class="amount-cell">Rs. ${transport.fuel.toLocaleString()}</td>
    </tr>`;
    grandTotal += transport.fuel;
    
    html += `<tr>
        <td>Toll & Challan</td>
        <td>Road taxes and permits</td>
        <td>1</td>
        <td>Rs. ${transport.toll.toLocaleString()}</td>
        <td class="amount-cell">Rs. ${transport.toll.toLocaleString()}</td>
    </tr>`;
    grandTotal += transport.toll;
    
    html += `<tr>
        <td>First Aid Box</td>
        <td>Compulsory safety kit</td>
        <td>1</td>
        <td>Rs. ${transport.firstAid.toLocaleString()}</td>
        <td class="amount-cell">Rs. ${transport.firstAid.toLocaleString()}</td>
    </tr>`;
    grandTotal += transport.firstAid;
    
    // Accommodation Section
    html += `<tr class="category-header"><td colspan="5"><strong>ACCOMMODATION (${roomCategory.toUpperCase()})</strong></td></tr>`;
    const roomRate = pkg.accommodation[roomCategory];
    const accomAmount = numRooms * numNights * roomRate;
    html += `<tr>
        <td>Hotel Rooms</td>
        <td>${roomCategory.charAt(0).toUpperCase() + roomCategory.slice(1)} category rooms</td>
        <td>${numRooms} rooms × ${numNights} nights</td>
        <td>Rs. ${roomRate.toLocaleString()}/night</td>
        <td class="amount-cell">Rs. ${accomAmount.toLocaleString()}</td>
    </tr>`;
    grandTotal += accomAmount;
    
    // Food Section
    html += `<tr class="category-header"><td colspan="5"><strong>FOOD</strong></td></tr>`;
    const breakfastAmount = numPeople * numDays * pkg.food.breakfast;
    html += `<tr>
        <td>Breakfast</td>
        <td>Egg, Pratha, Tea, Chanay, Bread, Jam</td>
        <td>${numPeople} people × ${numDays} days</td>
        <td>Rs. ${pkg.food.breakfast.toLocaleString()}/person</td>
        <td class="amount-cell">Rs. ${breakfastAmount.toLocaleString()}</td>
    </tr>`;
    grandTotal += breakfastAmount;
    
    const dinnerAmount = numPeople * numDays * pkg.food.dinner;
    html += `<tr>
        <td>Dinner</td>
        <td>Chicken Dish, Daal, Rotti, Salad, Raita, Cold Drink</td>
        <td>${numPeople} people × ${numDays} days</td>
        <td>Rs. ${pkg.food.dinner.toLocaleString()}/person</td>
        <td class="amount-cell">Rs. ${dinnerAmount.toLocaleString()}</td>
    </tr>`;
    grandTotal += dinnerAmount;
    
    // Activities Section
    html += `<tr class="category-header"><td colspan="5"><strong>ACTIVITIES (Optional)</strong></td></tr>`;
    html += `<tr>
        <td>Bonfire + Musical Night</td>
        <td>Evening entertainment</td>
        <td><input type="number" min="0" max="10" value="0" style="width:60px;padding:5px;" onchange="updateActivities()"></td>
        <td>Rs. ${pkg.activities.bonfire.toLocaleString()}/night</td>
        <td class="amount-cell" id="bonfire-amount">Rs. 0</td>
    </tr>`;
    
    html += `<tr>
        <td>Tour Guide</td>
        <td>Professional guide services</td>
        <td><input type="number" min="0" max="${numDays}" value="0" style="width:60px;padding:5px;" onchange="updateActivities()"></td>
        <td>Rs. ${pkg.activities.guide.toLocaleString()}/day</td>
        <td class="amount-cell" id="guide-amount">Rs. 0</td>
    </tr>`;
    
    // Total Row
    html += `<tr class="total-row">
        <td colspan="4" style="text-align: right;"><strong>GRAND TOTAL</strong></td>
        <td id="grandTotal" style="text-align: right;"><strong>Rs. ${grandTotal.toLocaleString()}</strong></td>
    </tr>`;
    
    // Per Person Row
    const perPerson = Math.round(grandTotal / numPeople);
    html += `<tr class="subtotal-row">
        <td colspan="4" style="text-align: right;"><strong>PER PERSON</strong></td>
        <td id="perHead" style="text-align: right;"><strong>Rs. ${perPerson.toLocaleString()}</strong></td>
    </tr>`;
    
    document.getElementById('mainTableBody').innerHTML = html;
}

function updateActivities() {
    const pkg = packageData[currentPackage];
    const tbody = document.getElementById('mainTableBody');
    const inputs = tbody.querySelectorAll('input[type="number"]');
    
    let bonfireQty = 0, guideQty = 0;
    inputs.forEach((input, index) => {
        if (index === 0) bonfireQty = parseInt(input.value) || 0;
        if (index === 1) guideQty = parseInt(input.value) || 0;
    });
    
    const bonfireAmount = bonfireQty * pkg.activities.bonfire;
    const guideAmount = guideQty * pkg.activities.guide;
    
    document.getElementById('bonfire-amount').textContent = 'Rs. ' + bonfireAmount.toLocaleString();
    document.getElementById('guide-amount').textContent = 'Rs. ' + guideAmount.toLocaleString();
    document.getElementById('activitiesCost').textContent = 'Rs. ' + (bonfireAmount + guideAmount).toLocaleString();
    
    // Recalculate grand total
    const numPeople = parseInt(document.getElementById('numPeople').value) || 1;
    const numDays = parseInt(document.getElementById('numDays').value) || 0;
    const numNights = parseInt(document.getElementById('numNights').value) || 0;
    const transportType = document.getElementById('transportType').value;
    const numRooms = parseInt(document.getElementById('numRooms').value) || 0;
    const roomCategory = document.getElementById('roomCategory').value;
    
    const transport = packageData[currentPackage].transport[transportType];
    const transportCost = (transport.rent * numDays) + transport.fuel + transport.toll + transport.firstAid;
    const accommodationCost = numRooms * numNights * packageData[currentPackage].accommodation[roomCategory];
    const foodCost = numPeople * numDays * (packageData[currentPackage].food.breakfast + packageData[currentPackage].food.dinner);
    
    const newTotal = transportCost + accommodationCost + foodCost + bonfireAmount + guideAmount;
    
    document.getElementById('grandTotal').innerHTML = '<strong>Rs. ' + newTotal.toLocaleString() + '</strong>';
    document.getElementById('perHead').innerHTML = '<strong>Rs. ' + Math.round(newTotal / numPeople).toLocaleString() + '</strong>';
}

function saveData() {
    const data = {
        package: currentPackage,
        packageName: packageData[currentPackage].name,
        people: document.getElementById('numPeople').value,
        days: document.getElementById('numDays').value,
        nights: document.getElementById('numNights').value,
        transport: document.getElementById('transportType').value,
        rooms: document.getElementById('numRooms').value,
        roomCategory: document.getElementById('roomCategory').value,
        total: document.getElementById('grandTotal').textContent,
        perPerson: document.getElementById('perHead').textContent,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentPackage}-quotation-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function downloadPDF() {
    window.print();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCalculations();
});
</script>
{% endblock %}
